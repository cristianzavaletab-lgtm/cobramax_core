{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-3">
  <div class="row justify-content-center">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Probar envío de Notificación</h5>
          <small class="text-muted">Entorno de desarrollo</small>
        </div>
        <div class="card-body">
          <form method="post" id="testSendForm" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="mb-3">
              {{ form.canal.label_tag }}
              {{ form.canal }}
            </div>
            <div class="mb-3">
              <label for="clienteSearch" class="form-label small">Cliente (opcional)</label>
              <div class="input-group">
                <input id="clienteSearch" class="form-control form-control-sm" placeholder="Buscar cliente por nombre, teléfono o email" aria-label="Buscar cliente">
                <button id="clearCliente" class="btn btn-outline-secondary d-none" type="button">Limpiar</button>
              </div>
              <input type="hidden" name="cliente_id" id="cliente_id">
              <div id="clienteSuggestions" class="list-group position-absolute w-100" style="z-index:1050; max-height:220px; overflow:auto; display:none"></div>
              <div class="form-text">Puedes seleccionar un cliente existente para persistir la notificación (opcional).</div>
            </div>
            <div class="mb-3">
              {{ form.telefono.label_tag }}
              {{ form.telefono }}
              <div class="form-text">Ingrese teléfono en formato internacional (+51...)</div>
            </div>
            <div class="mb-3">
              {{ form.email.label_tag }}
              {{ form.email }}
            </div>
            <div class="mb-3">
              {{ form.mensaje.label_tag }}
              {{ form.mensaje }}
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" value="1" id="enqueue" name="enqueue" checked>
              <label class="form-check-label small" for="enqueue">Enviar en background (usando Celery)</label>
            </div>
            <div class="d-grid">
              <button id="btnSend" class="btn btn-primary btn-lg w-100" type="submit">
                <span id="btnText">Enviar Prueba</span>
                <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </form>

          <div id="ajaxResult" class="mt-3"></div>

          {% if result %}
          <div class="mt-3">
            <h6>Resultado:</h6>
            <pre class="small bg-light p-2 rounded">{{ result|pprint }}</pre>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Small debounce helper
function debounce(fn, wait){
  let t;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=>fn.apply(this,args), wait);
  };
}

// Cliente autocomplete
(function(){
  const input = document.getElementById('clienteSearch');
  const suggestions = document.getElementById('clienteSuggestions');
  const hidden = document.getElementById('cliente_id');
  const clearBtn = document.getElementById('clearCliente');

  if(!input) return;

  const render = (items)=>{
    suggestions.innerHTML = '';
    if(!items.length){ suggestions.style.display = 'none'; return; }
    items.forEach(it=>{
      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'list-group-item list-group-item-action';
      el.textContent = it.label;
      el.dataset.id = it.id;
      el.dataset.telefono = it.telefono || '';
      el.dataset.email = it.email || '';
      el.addEventListener('click', ()=>{
        input.value = it.nombre;
        hidden.value = it.id;
        // fill phone/email fields for convenience
        const tel = document.querySelector('input[name="telefono"]');
        const email = document.querySelector('input[name="email"]');
        if(tel && it.telefono) tel.value = it.telefono;
        if(email && it.email) email.value = it.email;
        suggestions.style.display = 'none';
        clearBtn.classList.remove('d-none');
      });
      suggestions.appendChild(el);
    });
    suggestions.style.display = 'block';
  };

  const fetchClients = debounce(async (q)=>{
    if(!q || q.length < 2){ suggestions.style.display = 'none'; return; }
    try{
      const url = new URL('{% url "api_clientes_autocomplete" %}', window.location.origin);
      url.searchParams.set('q', q);
      const resp = await fetch(url.toString(), { headers: {'X-Requested-With':'XMLHttpRequest'} });
      const data = await resp.json();
      render(data.results || []);
    }catch(e){ console.error(e); }
  }, 250);

  input.addEventListener('input', (ev)=>{
    hidden.value = '';
    clearBtn.classList.add('d-none');
    fetchClients(ev.target.value.trim());
  });

  clearBtn.addEventListener('click', ()=>{
    input.value = '';
    hidden.value = '';
    clearBtn.classList.add('d-none');
    suggestions.style.display = 'none';
  });

  // hide suggestions on outside click
  document.addEventListener('click', (ev)=>{
    if(!suggestions.contains(ev.target) && ev.target !== input) suggestions.style.display = 'none';
  });
})();

document.getElementById('testSendForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const form = e.currentTarget;
  const btn = document.getElementById('btnSend');
  const spinner = document.getElementById('btnSpinner');
  const text = document.getElementById('btnText');
  const resultArea = document.getElementById('ajaxResult');

  if(btn){
    spinner.classList.remove('d-none');
    text.textContent = 'Enviando...';
    btn.disabled = true;
  }

  const data = new FormData(form);
  const headers = {
    'X-Requested-With': 'XMLHttpRequest',
    'Accept': 'application/json'
  };

  // CSRF token
  const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
  if(csrf) headers['X-CSRFToken'] = csrf;

  try{
    const resp = await fetch(window.location.href, {
      method: 'POST',
      headers: headers,
      body: data,
      credentials: 'same-origin'
    });

    if(resp.headers.get('content-type')?.includes('application/json')){
      const payload = await resp.json();
      resultArea.innerHTML = '';
      const box = document.createElement('div');
      box.className = 'mt-3';

      // Friendly feedback
      if(payload.ok){
        const res = payload.result || {};
        if(res.queued){
          box.innerHTML = `<div class="alert alert-info small"><strong>Encolado</strong> La tarea fue encolada. Task ID: <code>${res.task_id || ''}</code></div>`;
        } else {
          // fallback synchronous
          const success = res.success === undefined ? true : !!res.success;
          const stored = res.stored ? true : false;
          const err = res.error || res.detail || null;
          let inner = '';
          if(success){
            inner += `<div class="alert alert-success small"><strong>Envío síncrono</strong> El mensaje fue enviado correctamente.</div>`;
          } else {
            inner += `<div class="alert alert-warning small"><strong>Envío síncrono</strong> Hubo un problema al enviar el mensaje.${err?(' Error: '+err):''}</div>`;
          }
          inner += `<div class="small mt-2">Persistido en base de datos: <strong>${stored? 'Sí' : 'No'}</strong></div>`;
          inner += `<pre class="small bg-light p-2 rounded mt-2">${JSON.stringify(res, null, 2)}</pre>`;
          box.innerHTML = inner;
        }
      } else {
        box.innerHTML = `<div class="alert alert-danger small">${JSON.stringify(payload, null, 2)}</div>`;
      }
      resultArea.appendChild(box);
    } else {
      // fallback: render text
      const textResp = await resp.text();
      resultArea.innerHTML = `<pre class="small bg-light p-2 rounded">${textResp}</pre>`;
    }
  } catch(err){
    resultArea.innerHTML = `<div class="alert alert-danger small">Error: ${err.message}</div>`;
  } finally {
    if(btn){
      spinner.classList.add('d-none');
      text.textContent = 'Enviar Prueba';
      btn.disabled = false;
    }
  }
});
</script>

{% endblock %}
