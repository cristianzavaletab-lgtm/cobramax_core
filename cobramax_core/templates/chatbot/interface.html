<!-- templates/chatbot/interface.html -->
{% extends 'base.html' %}

{% block page_title %}Chatbot de Soporte{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-robot"></i> Asistente Virtual COBRA-MAX
                </h5>
            </div>
            
            <div class="card-body" style="height: 500px; overflow-y: auto;" id="chat-container">
                <div class="mb-3" id="mensajes">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        ¡Hola! Soy tu asistente virtual. ¿En qué puedo ayudarte?
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <form id="chat-form">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               id="mensaje-input" 
                               placeholder="Escribe tu mensaje...">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const input = document.getElementById('mensaje-input');
    const mensaje = input.value.trim();
    
    if (!mensaje) return;
    
    // Agregar mensaje del usuario
    agregarMensaje(mensaje, 'usuario');
    input.value = '';
    
    // Enviar a la API
    try {
        const response = await fetch('/chatbot/respuesta/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ mensaje: mensaje })
        });
        
        const data = await response.json();
        
        if (data.success) {
            agregarMensaje(data.respuesta, 'bot');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

function agregarMensaje(texto, tipo) {
    const mensajes = document.getElementById('mensajes');
    const div = document.createElement('div');
    div.className = tipo === 'usuario' ? 'alert alert-secondary text-end' : 'alert alert-primary';
    div.innerHTML = `<i class="fas fa-${tipo === 'usuario' ? 'user' : 'robot'}"></i> ${texto}`;
    mensajes.appendChild(div);
    
    // Scroll al final
    document.getElementById('chat-container').scrollTop = 9999;
}
</script>
{% endblock %}