{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-money-bill-wave"></i> Gestión de Cobranza</h2>
        <div>
            <a href="{% url 'registrar_pago' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Registrar Pago
            </a>
        </div>
    </div>

  <!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Total Pagos</h5>
                <h2>{{ total_pagos }}</h2>
                <p class="card-text">Registros en sistema</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Monto Total</h5>
                <h2>S/ {{ total_monto }}</h2>
                <p class="card-text">Recaudado</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Pagos Completados</h5>
                <h2>{{ pagos_completados }}</h2>
                <p class="card-text">Validados</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
    <div class="card bg-warning text-white">
        <div class="card-body">
            <h5 class="card-title">Pendientes</h5>
            <h2>{{ pagos_pendientes }}</h2>
            <p class="card-text">Por validar</p>
        </div>
    </div>
    </div>
</div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="estado" class="form-label">Estado:</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="">Todos los estados</option>
                        {% for estado_val, estado_label in estados %}
                        <option value="{{ estado_val }}" 
                                {% if request.GET.estado == estado_val %}selected{% endif %}>
                            {{ estado_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="metodo" class="form-label">Método:</label>
                    <select class="form-select" id="metodo" name="metodo">
                        <option value="">Todos los métodos</option>
                        {% for metodo_val, metodo_label in metodos %}
                        <option value="{{ metodo_val }}" 
                                {% if request.GET.metodo == metodo_val %}selected{% endif %}>
                            {{ metodo_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="fecha_desde" class="form-label">Desde:</label>
                    <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" 
                           value="{{ request.GET.fecha_desde }}">
                </div>
                <div class="col-md-3">
                    <label for="fecha_hasta" class="form-label">Hasta:</label>
                    <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta"
                           value="{{ request.GET.fecha_hasta }}">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <a href="{% url 'lista_pagos' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de pagos -->
    <div class="card">
        <div class="card-body">
            {% if pagos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Cliente</th>
                            <th>Monto</th>
                            <th>Método</th>
                            <th>Estado</th>
                            <th>Fecha Pago</th>
                            <th>Validado Por</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos %}
                        <tr>
                            <td><strong>{{ pago.codigo_transaccion }}</strong></td>
                            <td>
                                {{ pago.cliente.nombre_completo }}<br>
                                <small class="text-muted">{{ pago.cliente.dni }}</small>
                            </td>
                            <td>
                                <strong class="text-success">S/ {{ pago.monto }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ pago.get_metodo_pago_display }}</span>
                            </td>
                            <td>
                                <span class="badge bg-{% if pago.estado == 'completado' %}success{% elif pago.estado == 'pendiente' %}warning{% else %}danger{% endif %}">
                                    {{ pago.get_estado_display }}
                                </span>
                            </td>
                            <td>{{ pago.fecha_pago|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if pago.validado_por %}
                                {{ pago.validado_por.get_full_name|default:pago.validado_por.username }}
                                {% else %}
                                <span class="text-muted">Pendiente</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'detalle_pago' pago.id %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> Ver
                                </a>
                                {% if pago.estado == 'pendiente' and user.tipo_usuario in 'admin,oficina' %}
                                <a href="{% url 'validar_pago' pago.id %}" 
                                   class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-check"></i> Validar
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                <h5>No se encontraron pagos</h5>
                <p class="text-muted">No hay pagos que coincidan con los filtros aplicados.</p>
                <a href="{% url 'registrar_pago' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Registrar primer pago
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}